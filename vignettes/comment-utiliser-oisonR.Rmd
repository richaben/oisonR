---
title: "Comment utiliser le package oisonR ?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comment utiliser le package oisonR ?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{mapview}
  %\VignetteDepends{COGiter}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## R√©cup√©rer les donn√©es via l'acc√®s √† la base SQL

### Chargement des packages

```{r setup, message=FALSE, warning=FALSE}
library(oisonR)
library(sf)
library(dplyr)
# devtools::install_github("MaelTheuliere/COGiter")
library(COGiter)
```

### Les *observations taxons*

La fonction `get_table_taxon_sql()` permet de r√©cup√©rer les donn√©es d'*observations taxons* de la base SQL OISON. Avant de l'utiliser, il faut initier la connexion √† la base de donn√©es avec la fonction `init_connexion_sql()` (et s'assurer de disposer des param√®tres de configuration). Apr√®s requ√™te, la fermeture de la connexion est conseill√© avec la fonction `stop_sql_connexion()`. 

Par d√©faut, l'ensemble des observations est r√©cup√©r√©, sauf si une g√©om√©trie est pr√©cis√©e en argument dans la fonction. 

> *L'exemple ci-dessous pr√©sente le cas d'un export sur les observations taxons r√©alis√©s en Bretagne*.

  - Cr√©ation d'une g√©om√©trie pour la Bretagne :

Le package R `COGiter` peut √™tre utilis√© pour cr√©er simplement une g√©om√©trie et la convertir en cha√Æne de caract√®res utilisable pour la requ√™te SQL.

```{r}
geom_BZH <-
  COGiter::regions_geo %>%
  # filtre sur BZH
  dplyr::filter(REG == 53) %>%
  sf::st_as_sfc() %>%
  # convert to text
  sf::st_as_text()
```

```{r, echo = FALSE}
string_geom_exemple <- paste0(substr(geom_BZH,1,100), '....')
```

Le d√©but de la g√©om√©trie ressemble √† cela : 
`r string_geom_exemple`. 

  - Requ√™te observations taxons :

```{r, eval=FALSE, message=FALSE, warning=FALSE}
# initialisation de la connexion
bdd_oison <- start_sql_connexion()

# requete
oison_BZH <- 
  get_table_taxon_sql(conn = bdd_oison,
                      geometrie = geom_BZH)

# stop de la connexion
stop_sql_connexion(conn = bdd_oison)
```

Le r√©sultat de la requ√™te est un objet de type `data.frame`. Les noms de colonnes sont les suivants :

```{r, eval=FALSE}
oison_BZH %>% 
  names()
```

A noter, qu'il s'agit ici d'une vue simplifi√©e par rapport √† ce qu'il est possible d'exporter directement dans l'application OISON (les exports et formats d'exports de l'application OISON n'√©tant pas satisfaisants). Ici, le format est directement exploitable et manipulable pour valorisation ult√©rieure. 

Par exemple, si l'on souhaite extraire les taxons correspondant aux √©crevisses observ√©es sur l'ann√©e 2023, il suffit de faire :

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023 <-
  oison_BZH %>% 
  # detect pattern 'creviss' and filter
  dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
  dplyr::mutate(annee = format(date, '%Y')) %>% 
  dplyr::filter(annee == 2023)
```

Pour une r√©utilisation en analyse spatiale, la colonne `geometry` peut facilement √™tre convertie au format `sf` (*simple features*) avec la fonction `sf::st_as_sf()`.

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023_sf <-
  oison_BZH_ecrevisse_2023 %>% 
  sf::st_as_sf()
```

Les repr√©sentations interactives sont possibles (*√† noter que dans l'exemple ci-dessous il ne s'agit pas des vraies donn√©es... floutage !* üï∂) :

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023_sf %>% 
  mapview::mapview()
```

```{r, echo=FALSE}
# oison_BZH_ecrevisse_2023 <-
#   oison_BZH %>% 
#   # detect pattern 'creviss' and filter
#   dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
#   dplyr::mutate(annee = format(date, '%Y')) %>% 
#   dplyr::filter(annee == 2023)
# 
# oison_BZH_ecrevisse_2023_sf <-
#   oison_BZH_ecrevisse_2023 %>% 
#   sf::st_as_sf() %>% 
#   dplyr::mutate(row = paste('id',row_number())) %>% 
#   dplyr::select(row) %>% 
#   sf::st_jitter(factor = .05)
# 
# mapview::mapview(oison_BZH_ecrevisse_2023_sf, legend = FALSE)
```

L'export au format *geopackage* `gpkg` est possible pour une r√©utilisation sous SIG. Les g√©om√©tries sont conserv√©es, et c'est important car diff√©rents types peuvent √™tre saisis dans OISON (point, polygones, polylignes, ...).

```{r, eval=FALSE, fig.width=4, fig.height=4}
sf::write_sf(oison_BZH_ecrevisse_2023_sf, 
             "D:/oison_BZH_ecrevisse_2023.gpkg", 
             driver = "GPKG")
```

### Les *observations milieu*

TO BE CONTINUED... üõ†


## R√©cup√©rer les donn√©es via l'API

TO BE CONTINUED... üõ†
