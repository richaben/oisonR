---
title: "2. Comment utiliser le package oisonR ?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2. Comment utiliser le package oisonR ?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{mapview}
  %\VignetteDepends{COGiter}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## R√©cup√©rer les donn√©es via l'acc√®s √† la base SQL

### Chargement des packages

Quelques packages sont n√©cessaires pour ex√©cuter les exemples ci-dessous.

```{r setup, message=FALSE, warning=FALSE}
library(oisonR)
library(sf)
library(dplyr)
# devtools::install_github("MaelTheuliere/COGiter")
library(COGiter)
```

### Les observations taxons

Les *observations taxons* de [OISON](https://oison.ofb.fr/) sont r√©cup√©rables avec la fonction `get_table_taxon_sql()`. Avant son utilisation, il faut toutefois : 

  - s'assurer de disposer des param√®tres de connexion √† la base SQL (*cf*. la vignette `oisonR` pour plus de d√©tails) ;
  - puis, initier la connexion √† la base de donn√©es avec la fonction `start_sql_connexion()`.

La fonction permet de r√©cup√©rer l'ensemble des observations de la base, sauf si une g√©om√©trie est pr√©cis√©e en argument (argument `geometrie` dans la fonction).

Apr√®s r√©cup√©ration des donn√©es, il est conseill√© de stopper la connexion √† la base avec la fonction `stop_sql_connexion()`.

### Exemple pour r√©aliser un export des observations taxons sur les √©crevisses en Bretagne pour l'ann√©e 2023

#### 1. Cr√©ation d'une g√©om√©trie pour la Bretagne

Le package `COGiter` peut √™tre utilis√© pour r√©cup√©rer la g√©om√©trie correspondant √† la r√©gion, et la convertir en cha√Æne de caract√®res pour effectuer la requ√™te.

```{r}
geom_BZH <-
  COGiter::regions_geo %>%
  # filtre sur BZH
  dplyr::filter(REG == 53) %>%
  sf::st_as_sfc() %>%
  # convert to text
  sf::st_as_text()
```

```{r, echo = FALSE}
string_geom_exemple <- paste0(substr(geom_BZH,1,100), '....')
```

Le d√©but de la g√©om√©trie prend la forme suivante : 
`r string_geom_exemple`. 

#### 2. R√©cup√©ration des donn√©es *observations taxons*

```{r, eval=FALSE, message=FALSE, warning=FALSE}
# a) connexion
bdd_oison <- start_sql_connexion()

# b) requete
oison_BZH <- 
  get_table_taxon_sql(conn = bdd_oison,
                      geometrie = geom_BZH)

# d) stop de la connexion
stop_sql_connexion(conn = bdd_oison)
```

Le r√©sultat de la requ√™te est un objet de type `data.frame`. Les noms de colonnes peuvent √™tre obtenus de la fa√ßon suivante :

```{r, eval=FALSE}
oison_BZH %>% 
  names()
```

```{r varnames, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_table_taxons_variables.png")
```

> ‚ö†Ô∏è A noter qu'ici les champs de donn√©es peuvent √™tre diff√©rents de ceux pr√©sents dans les exports de l'application OISON* (*i.e* *champs manquants). Une vue simplifi√©e et facilement utilisable a √©t√© privilig√©e ! 

####  3. Filtrage des donn√©es

Pour extraire les observations taxons correspondant aux √©crevisses observ√©es en 2023, il suffit de r√©aliser un filtrage √† partir (i) de la colonne `nom_vernaculaire` et (ii) de la nouvelle colonne `annee` (cr√©√©e √† partir de la colonne `date`) :

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023 <-
  oison_BZH %>% 
  # detection pattern 'creviss' et filtre
  dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
  # cr√©ation colonne annee
  dplyr::mutate(annee = format(date, '%Y')) %>% 
  # filtre sur annee 2023
  dplyr::filter(annee == 2023)
```

#### 4. Visualisation des donn√©es
  
Pour une r√©utilisation en analyse spatiale, la colonne `geometry` doit √™tre convertie au format `sf` (*simple features*) avec la fonction `st_as_sf()` du package `sf`.

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023_sf <-
  oison_BZH_ecrevisse_2023 %>% 
  sf::st_as_sf()
```

Avec cet objet, les visualisations interactives sont possibles (*√† noter qu'il ne s'agit pas des vraies donn√©es dans l'exemple ci-dessous...* üï∂) avec le package `mapview` :

```{r, eval=FALSE, fig.width=4, fig.height=4}
oison_BZH_ecrevisse_2023_sf %>% 
  mapview::mapview()
```

```{r exemple_mapview, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_exemple_ecrevisses_bzh.png")
```

```{r, echo=FALSE}
# oison_BZH_ecrevisse_2023 <-
#   oison_BZH %>% 
#   # detect pattern 'creviss' and filter
#   dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
#   dplyr::mutate(annee = format(date, '%Y')) %>% 
#   dplyr::filter(annee == 2023)
# 
# oison_BZH_ecrevisse_2023_sf <-
#   oison_BZH_ecrevisse_2023 %>% 
#   sf::st_as_sf() %>% 
#   dplyr::mutate(row = paste('id',row_number())) %>% 
#   dplyr::select(row) %>% 
#   sf::st_jitter(factor = .05)
# 
# mapview::mapview(oison_BZH_ecrevisse_2023_sf, legend = FALSE)
```

#### 5. Export des donn√©es

L'export sous diff√©rents formats est possible, dont le format *geopackage* `.gpkg` pour une r√©utilisation sous SIG.

> üí° Le format `gpkg` permet de conserver dans le m√™me objet les diff√©rents types de g√©om√©tries pouvant se retrouver dans OISON (points, polygones, lignes, ...).

```{r, eval=FALSE}
sf::write_sf(oison_BZH_ecrevisse_2023_sf, 
             "D:/oison_BZH_ecrevisse_2023.gpkg", 
             driver = "GPKG")
```

### Les observations milieu

TO COMPLETE... üõ†


## R√©cup√©rer les donn√©es via l'API

TO COMPLETE... üõ†
