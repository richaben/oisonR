---
title: "2. Comment utiliser le package oisonR ?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2. Comment utiliser le package oisonR ?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{mapview}
  %\VignetteDepends{COGiter}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# R√©cup√©rer les donn√©es via l'acc√®s √† la base SQL

## Chargement des packages

Quelques packages sont n√©cessaires pour ex√©cuter les exemples ci-dessous.

```{r setup, message=FALSE, warning=FALSE}
library(oisonR)
library(sf)
library(dplyr)
# devtools::install_github("MaelTheuliere/COGiter")
library(COGiter)
```

## Les observations taxons

Les *observations taxons* de [OISON](https://oison.ofb.fr/) sont r√©cup√©rables avec la fonction `get_table_taxon_sql()`. Avant son utilisation, il faut toutefois :

-   s'assurer de disposer des param√®tres de connexion √† la base SQL (*cf*. la vignette `oisonR` pour plus de d√©tails) ;
-   puis, initier la connexion √† la base de donn√©es avec la fonction `start_sql_connexion()`.

La fonction permet de r√©cup√©rer l'ensemble des observations de la base, sauf si une g√©om√©trie est pr√©cis√©e en argument (argument `geometrie` dans la fonction).

Apr√®s r√©cup√©ration des donn√©es, il est conseill√© de stopper la connexion √† la base avec la fonction `stop_sql_connexion()`.

### Exemple pour r√©aliser un export des observations taxons sur les √©crevisses en Bretagne pour l'ann√©e 2023

#### 1. Cr√©ation d'une g√©om√©trie pour la Bretagne

Le package `COGiter` peut √™tre utilis√© pour r√©cup√©rer la g√©om√©trie correspondant √† la r√©gion, et la convertir en cha√Æne de caract√®res utilisables pour la requ√™te spatiale.

```{r}
geom_BZH <-
  COGiter::regions_geo %>%
  # filtre sur BZH
  dplyr::filter(REG == 53) %>%
  sf::st_as_sfc() %>%
  # convert to text
  sf::st_as_text()
```

```{r, echo = FALSE}
string_geom_exemple <- paste0(substr(geom_BZH,1,100), '....')
```

Le d√©but de la g√©om√©trie prend la forme suivante : `r string_geom_exemple`.

#### 2. R√©cup√©ration des donn√©es *observations taxons*

```{r, eval=FALSE, message=FALSE, warning=FALSE}
# a) connexion
bdd_oison <- start_sql_connexion()

# b) requete
oison_BZH <- 
  get_table_taxon_sql(conn = bdd_oison,
                      geometrie = geom_BZH)

# d) stop de la connexion
stop_sql_connexion(conn = bdd_oison)
```

Le r√©sultat de la requ√™te est un objet de type `data.frame`. Les noms de colonnes peuvent √™tre obtenus de la fa√ßon suivante :

```{r, eval=FALSE}
oison_BZH %>% 
  names()
```

```{r varnames, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_table_taxons_variables.png")
```

> ‚ö†Ô∏è A noter qu'ici les champs de donn√©es peuvent √™tre diff√©rents de ceux pr√©sents dans les exports de l'application OISON\* (*i.e* \*champs manquants). Une vue simplifi√©e et facilement utilisable a √©t√© privilig√©e !

#### 3. Filtrage des donn√©es

Pour extraire les *observations taxons* correspondant aux √©crevisses dat√©es de 2023, il suffit de r√©aliser un filtrage √† partir (i) de la colonne `nom_vernaculaire` et (ii) de la nouvelle colonne `annee` (cr√©√©e √† partir de la colonne `date`) :

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023 <-
  oison_BZH %>% 
  # detection pattern 'creviss' et filtre
  dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
  # cr√©ation colonne annee
  dplyr::mutate(annee = format(date, '%Y')) %>% 
  # filtre sur annee 2023
  dplyr::filter(annee == 2023)
```

#### 4. Visualisation des donn√©es

Pour une r√©utilisation en analyse spatiale, la colonne `geometry` doit √™tre convertie au format `sf` (*simple features*) avec la fonction `st_as_sf()` du package `sf`.

```{r, eval=FALSE}
oison_BZH_ecrevisse_2023_sf <-
  oison_BZH_ecrevisse_2023 %>% 
  sf::st_as_sf()
```

Avec cet objet, les visualisations interactives sont possibles avec le package `mapview` (*√† noter qu'il ne s'agit pas des vraies donn√©es dans l'exemple ci-dessous...* üï∂)  :

```{r, eval=FALSE, fig.width=4, fig.height=4}
oison_BZH_ecrevisse_2023_sf %>% 
  mapview::mapview()
```

```{r exemple_mapview, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_exemple_ecrevisses_bzh.png")
```

```{r, echo=FALSE}
# oison_BZH_ecrevisse_2023 <-
#   oison_BZH %>% 
#   # detect pattern 'creviss' and filter
#   dplyr::filter(grepl('creviss', nom_vernaculaire)) %>% 
#   dplyr::mutate(annee = format(date, '%Y')) %>% 
#   dplyr::filter(annee == 2023)
# 
# oison_BZH_ecrevisse_2023_sf <-
#   oison_BZH_ecrevisse_2023 %>% 
#   sf::st_as_sf() %>% 
#   dplyr::mutate(row = paste('id',row_number())) %>% 
#   dplyr::select(row) %>% 
#   sf::st_jitter(factor = .05)
# 
# mapview::mapview(oison_BZH_ecrevisse_2023_sf, legend = FALSE)
```

#### 5. Export des donn√©es

L'export sous diff√©rents formats est possible, dont le format *geopackage* (`.gpkg`) pour une r√©utilisation sous SIG.

> üí° Le format `gpkg` permet de conserver les diff√©rents types de g√©om√©tries pouvant se retrouver dans les observations OISON (points, polygones, lignes, ...).

```{r, eval=FALSE}
sf::write_sf(oison_BZH_ecrevisse_2023_sf, 
             "D:/oison_BZH_ecrevisse_2023.gpkg", 
             driver = "GPKG")
```

## Les observations milieu

Les *observations milieu* de [OISON](https://oison.ofb.fr/) sont r√©cup√©rables avec la fonction `get_table_milieu_sql()`. Comme pr√©c√©demment, il faut disposer des param√®tres de connexion √† la base SQL (*cf*. la vignette `oisonR` pour plus de d√©tails).

Par d√©faut, la fonction permet de r√©cup√©rer l'ensemble des observations de la base, sauf si une g√©om√©trie est pr√©cis√©e en argument (argument `geometrie` dans la fonction).

### Exemple pour les observations milieu pour la r√©gion Bretagne

L'exemple ci-dessous correspond √† une extraction des *observations milieu* sur la zone g√©ographique de la r√©gion Bretagne, en utilisant l'objet pr√©c√©demment cr√©√© (`geom_BZH` ; cf. ci-dessus) :

```{r, eval=FALSE, message=FALSE, warning=FALSE}
# a) connexion
bdd_oison <- start_sql_connexion()

# b) requete
oison_milieu_BZH <- 
  get_table_milieu_sql(conn = bdd_oison,
                      geometrie = geom_BZH)

# d) stop de la connexion
stop_sql_connexion(conn = bdd_oison)
```

Le r√©sultat de la requ√™te est de nouveau un objet de type `data.frame`. Les noms de colonnes peuvent √™tre obtenus de la fa√ßon suivante :

```{r, eval=FALSE}
oison_milieu_BZH %>% 
  names()
```


```{r varnames_milieu, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_table_milieu_variables.png")
```


# R√©cup√©rer les donn√©es via l'API

Trois fonctions permettent de r√©cup√©rer les donn√©es via une "API". Pour le moment, il n'est possible que de r√©cup√©rer les *observations taxons*. Les fonctions sont les suivantes :

- `get_taxon_dpt()` pour r√©cup√©rer les *observations taxons* sur un d√©partement en sp√©cifiant son code insee ;
- `get_taxon_region()` pour r√©cup√©rer les *observations taxons* sur une r√©gion en sp√©cifiant son code insee ;
- `get_taxon_polygon()` pour r√©cup√©rer les *observations taxons* sur une zone g√©ographique d√©finie au pr√©alable ou trac√©e √† la vol√©e avec une fonction d√©di√©e.

Avec ces 3 fonctions, il est possible de collecter les donn√©es (avec l'argument `collect_all = TRUE`) ou simplement consulter rapidement le nombre de donn√©es sur l'√©tendue g√©ographique (lorsque l'argument `collect_all = FALSE`).

Une p√©riode de temps peut √™tre √©galement sp√©cifi√©e avec les arguments `date_min` et `date_max`.

La r√©cup√©ration des donn√©es est s√©quenc√©e pour limiter la surcharge de l'API.

### Exemples pour le d√©partement 27 avec `get_taxon_dpt()`  

#### Consultation simple sur l'ann√©e 2022 (avec `collect_all = FALSE`)

```{r, eval=FALSE}
get_taxon_dpt(
  dpt_code = "27",
  login = "john.doe@ofb.gouv.fr",
  mdp = "mon_mdp",
  date_min = '2022-01-01',
  date_max = '2022-12-31',
  collect_all = F)
```

```{r oison_api_dpt, echo=FALSE, out.width="80%"}
knitr::include_graphics("../man/figures/oison_api_dpt.png")
```

#### R√©cup√©ration des donn√©es sur l'ann√©e 2022 (avec `collect_all = TRUE`)

```{r, eval=FALSE}
oison_27_df <- 
  get_taxon_dpt(
  dpt_code = "27",
  login = "john.doe@ofb.gouv.fr",
  mdp = "mon_mdp",
  date_min = '2022-01-01',
  date_max = '2022-12-31',
  collect_all = T)
```

Le r√©sultat de la requ√™te est de nouveau un objet de type `data.frame`. Les noms de colonnes peuvent √™tre obtenus de la fa√ßon suivante :

```{r, eval=FALSE}
oison_27_df %>% 
  names()
```

```{r varnames_taxons_api, echo=FALSE, out.width="200%"}
knitr::include_graphics("../man/figures/oison_api_taxons_variables.png")
```

### Exemple avec la fonction `get_taxon_polygon()`

Cette fonction permet de consulter/r√©cup√©rer (selon l'argument `collect_all = FALSE` ou `collect_all = TRUE`) les donn√©es sur une zone g√©ographique d√©finie par un polygone. Sp√©cifier une plage de date est √©galement possible. 

Le polygone peut :

  - s'√©crire manuellement sous cette forme ;

```{r, echo=FALSE}
"POLYGON ((410677.9 6877209, 413275.2 6929083, 496961.8 6925506, 495122.6 6873600, 410677.9 6877209))"
```

  - se tracer √† la vol√©e lorsque l'argument `draw_zone = TRUE` est sp√©cifi√© dans la fonction. D√®s lors, un outil de s√©lection de zone s'ouvre (via une fen√™tre interactive `shiny` ; cf. ci-dessous) permettant le tra√ßage du polygone et son stockage dans l'environnement de travail pour la requ√™te.
  
```{r, eval=FALSE}
get_taxon_polygon(
  login = "john.doe@ofb.gouv.fr",
  mdp = "mon_mdp",
  draw_zone = T,
  collect_all = F)
```

```{r outil_tracage, echo=FALSE, out.width="100%"}
knitr::include_graphics("../man/figures/oison_outil_polygon.png")
```

```{r api_polygon, echo=FALSE, out.width="100%"}
knitr::include_graphics("../man/figures/oison_api_polygon.png")
```
